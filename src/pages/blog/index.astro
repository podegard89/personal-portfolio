---
import { useStoryblokApi } from "@storyblok/astro";
import Layout from "../../layouts/Layout.astro";
import BlogPostList from "../../storyblok/BlogPostList.astro";
import { StoryblokDataSchema } from "../../schemas/storyblok-schemas.ts";

const storyblokApi = useStoryblokApi();

const { data } = await storyblokApi.get("cdn/stories", {
  version: import.meta.env.DEV ? "draft" : "published",
  content_type: "blogPost",
});

const parsedData = StoryblokDataSchema.parse(data);

const sidebarItems: { name: string; href: string }[] = [];

const posts = parsedData.stories.map((story) => {
  sidebarItems.push({
    name: story.content.title,
    href: `#${story.name}`,
  });
  return {
    title: story.content.title,
    date: new Date(story.published_at).toLocaleDateString("en-US", {
      dateStyle: "full",
    }),
    description: story.content.description,
    slug: story.full_slug,
    image: story.content.image.filename,
    navId: story.name,
  };
});
---

<Layout title="Blog" sidebarItems={sidebarItems}>
  <!-- <StoryblokComponent blok={content} /> -->
  <BlogPostList posts={posts} />
</Layout>
